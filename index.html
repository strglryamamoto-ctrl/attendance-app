<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>出退勤トラッカー（LINEログイン + 管理者一覧版）</title>
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --ink: #1f2937;
      --ink-dim: #4b5563;
      --brand: #06c755; /* LINEグリーンに寄せる */
      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --muted: #e5e7eb;
      --shadow: 0 10px 30px rgba(17,24,39,0.08);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(135deg, #f2f6ff, #fefefe);
      color: var(--ink);
    }
    .container { max-width: 1100px; margin: 24px auto 64px; padding: 0 16px; }
    header { display: flex; gap: 16px; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .title { font-size: clamp(20px, 2.2vw, 28px); font-weight: 800; letter-spacing: .2px; display: flex; align-items: center; gap: 10px; }
    .clock { font-variant-numeric: tabular-nums; color: var(--ink-dim); }
    .grid { display: grid; gap: 18px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 18px; border: 1px solid var(--muted); }
    .row { display: flex; gap: 10px; align-items: center; }
    .row.wrap { flex-wrap: wrap; }
    .grow { flex: 1; }
    label { font-size: 12px; color: var(--ink-dim); display: block; margin-bottom: 6px; }
    input, select, button, textarea { font: inherit; border-radius: 12px; border: 1px solid var(--muted); padding: 10px 12px; background: #fff; color: var(--ink); }
    input:focus, select:focus, textarea:focus { outline: 2px solid #c7ddff; border-color: #a3c7ff; }
    button { border: none; cursor: pointer; font-weight: 700; letter-spacing: .2px; transition: transform .03s ease-in-out, box-shadow .2s; }
    button:active { transform: translateY(1px); }
    .btn { background: var(--brand); color: #fff; }
    .btn:hover { box-shadow: var(--shadow); }
    .btn-ghost { background: #fff; color: var(--ink); border: 1px solid var(--muted); }
    .btn-ok { background: var(--ok); color:#fff; }
    .btn-warn { background: var(--warn); color:#fff; }
    .btn-bad { background: var(--bad); color:#fff; }
    .tag { padding: 4px 8px; font-size: 12px; border-radius: 999px; border:1px solid var(--muted); background:#fff; }
    .kpi { font-weight: 800; font-size: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--muted); padding: 10px 8px; text-align: left; font-size: 14px; }
    th { font-size: 12px; color: var(--ink-dim); text-transform: uppercase; letter-spacing: .6px; }
    .hint { font-size: 12px; color: var(--ink-dim); }
    .pillbar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .pillbar button { padding: 12px 8px; }
    footer { margin-top: 16px; text-align: center; color: var(--ink-dim); font-size: 12px; }
    .danger { color: var(--bad); }
    .warn { color: var(--warn); }
    .mono { font-variant-numeric: tabular-nums; }
    .sr-only { position: absolute; left: -10000px; }
    .flex-between { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .avatar { width:32px; height:32px; border-radius:999px; object-fit:cover; border:1px solid var(--muted); }
    .role-badge { font-size:12px; border:1px solid var(--muted); border-radius:999px; padding:2px 8px; background:#fff; }
  </style>
  <!-- LINE LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Supabase（必要なら有効化） -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">出退勤トラッカー <span class="tag">LINEログイン対応</span></div>
      <div class="clock" id="clock">--:--:--</div>
    </header>

    <!-- ログイン状態バー -->
    <section class="card" style="margin-bottom:18px;">
      <div class="flex-between">
        <div id="loginState" class="row" style="gap:10px;">
          <img id="avatar" class="avatar" alt="avatar" src="" style="display:none;" />
          <div>
            <div id="welcome">未ログイン</div>
            <div class="hint" id="roleInfo">role: guest</div>
          </div>
        </div>
        <div class="row" style="gap:8px;">
          <button id="btnLogin" class="btn">LINEでログイン</button>
          <button id="btnLogout" class="btn-ghost" style="display:none;">ログアウト</button>
        </div>
      </div>
    </section>

    <div class="grid">
      <!-- 打刻カード -->
      <section class="card" aria-labelledby="ops-title">
        <div class="flex-between">
          <h2 id="ops-title" style="margin:0 0 10px 0; font-size:18px;">打刻</h2>
          <span class="role-badge" id="roleBadge">guest</span>
        </div>
        <div class="row wrap" style="gap:12px; margin-bottom:12px;">
          <div class="grow">
            <label for="user">ユーザー</label>
            <input id="user" placeholder="LINEログインで自動入力" disabled />
          </div>
          <div>
            <label for="team">チーム/拠点</label>
            <input id="team" placeholder="任意" />
          </div>
          <div>
            <label for="shiftStart">定時（開始）</label>
            <input type="time" id="shiftStart" value="09:00" />
          </div>
          <div>
            <label for="shiftEnd">定時（終了）</label>
            <input type="time" id="shiftEnd" value="18:00" />
          </div>
        </div>

        <div class="pillbar" style="margin-bottom:10px;">
          <button class="btn-ok" data-action="wake">起床</button>
          <button class="btn-warn" data-action="depart">出発</button>
          <button class="btn" data-action="clockin">出勤</button>
          <button class="btn-bad" data-action="clockout">退勤</button>
        </div>
        <div class="row wrap" style="gap:8px; margin-bottom:8px;">
          <input id="note" class="grow" placeholder="メモ（遅延理由など）" />
          <button class="btn-ghost" id="quickLate">5分遅れ</button>
          <button class="btn-ghost" id="quickWorkFromHome">在宅</button>
        </div>
        <div class="hint">LINEログインの表示名で記録します。誤打刻は一覧の🗑️で削除可。</div>
      </section>

      <!-- 今日のサマリー -->
      <section class="card" aria-labelledby="summary-title">
        <h2 id="summary-title" style="margin:0 0 10px 0; font-size:18px;">今日のサマリー</h2>
        <div class="row wrap" style="gap:12px;">
          <div class="card" style="flex:1; border:1px dashed var(--muted);">
            <div class="hint">打刻人数</div>
            <div class="kpi mono" id="kpiPeople">0</div>
          </div>
          <div class="card" style="flex:1; border:1px dashed var(--muted);">
            <div class="hint">遅刻（出勤が定時を超過）</div>
            <div class="kpi mono danger" id="kpiLate">0</div>
          </div>
          <div class="card" style="flex:1; border:1px dashed var(--muted);">
            <div class="hint">未出勤（起床/出発のみ）</div>
            <div class="kpi mono warn" id="kpiNoClockIn">0</div>
          </div>
        </div>
      </section>
    </div>

    <!-- ログテーブル（管理者向けは全体集計） -->
    <section class="card" style="margin-top:18px;" aria-labelledby="log-title">
      <div class="flex-between">
        <h2 id="log-title" style="margin:0 0 10px 0; font-size:18px;">ログ（本日）</h2>
        <div class="row" style="gap:8px;">
          <span class="hint" id="dataSource">Data: LocalStorage</span>
          <button id="exportCsv" class="btn">CSVエクスポート</button>
          <button id="exportJson" class="btn-ghost">JSON保存</button>
          <label for="importFile" class="btn-ghost" style="cursor:pointer;">JSON読み込み</label>
          <input id="importFile" type="file" accept="application/json" class="sr-only" />
          <button id="clearToday" class="btn-bad">今日を全消し</button>
        </div>
      </div>
      <div class="row wrap" style="gap:8px; margin-bottom:8px;">
        <input id="search" class="grow" placeholder="検索：氏名/メモ/チーム" />
        <select id="scope">
          <option value="mine">自分のみ</option>
          <option value="all">全体（管理者）</option>
        </select>
      </div>
      <div class="hint" id="alertZone">定時超過の人が出るとここに⚠️を表示します。</div>
      <div style="overflow:auto;">
        <table id="table">
          <thead>
            <tr>
              <th>氏名</th>
              <th>チーム</th>
              <th>起床</th>
              <th>出発</th>
              <th>出勤</th>
              <th>退勤</th>
              <th>メモ</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <footer>
      <span>保存先は LocalStorage / Supabase を選択可能。LINEログイン（LIFF）。</span>
    </footer>
  </div>

  <script>
    // ===================== 設定（ここを書き換え） =====================
    const LIFF_ID = '2007926375-NpkwlE1J'; // LINE Developers で取得
    const ADMINS = [U02a56336d5ae934d95a1bf5931b33b64];

    // Supabase（任意：全体共有や多拠点運用をするなら設定）
    const SUPABASE_URL = '';
    const SUPABASE_ANON_KEY = '';
    const USE_SUPABASE = !!(SUPABASE_URL && SUPABASE_ANON_KEY);

    // ===================== ユーティリティ =====================
    const $ = (s) => document.querySelector(s);
    const pad = (n) => String(n).padStart(2, '0');
    const todayStr = () => { const d = new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
    const nowIso = () => new Date().toISOString();
    const fmtTime = (iso) => iso ? new Date(iso).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '';

    let state = { profile:null, role:'guest', userName:'', userId:'', supabase:null };

    function tickClock(){ const d=new Date(); $('#clock').textContent=`${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
    setInterval(tickClock, 1000); tickClock();

    // ===================== データ層 =====================
    const LS_KEY = 'attendance.v2';

    // LocalStorage 実装
    function ls_getAll(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||{} }catch{ return {} } }
    function ls_setAll(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }
    function ls_getDay(date=todayStr()) { const all=ls_getAll(); return all[date]||[]; }
    function ls_setDay(list, date=todayStr()) { const all=ls_getAll(); all[date]=list; ls_setAll(all); }

    // Supabase 実装
    async function sb_init(){ if(!USE_SUPABASE) return null; state.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); return state.supabase; }
    async function sb_getDay(date=todayStr()){
      const { data, error } = await state.supabase.from('records').select('*').eq('date', date).order('team', { ascending:true }).order('name', { ascending:true });
      if(error){ console.error(error); alert('DB読み込みに失敗しました'); return []; }
      return data || [];
    }
    async function sb_upsert(rec){
      const payload = { ...rec, date: todayStr() };
      const { error } = await state.supabase.from('records').upsert(payload, { onConflict:'date,name' });
      if(error){ console.error(error); alert('DB書き込みに失敗しました'); }
    }
    async function sb_deleteByName(name){
      const { error } = await state.supabase.from('records').delete().eq('date', todayStr()).eq('name', name);
      if(error){ console.error(error); alert('DB削除に失敗しました'); }
    }

    // データ抽象レイヤー
    const store = {
      async getDay(){ return USE_SUPABASE ? await sb_getDay() : ls_getDay(); },
      async setOrUpsert(rec){
        if(USE_SUPABASE){ await sb_upsert(rec); }
        else {
          const list = ls_getDay();
          let found = list.find(r=>r.name===rec.name);
          if(found) Object.assign(found, rec); else list.push(rec);
          ls_setDay(list);
        }
      },
      async delByName(name){ return USE_SUPABASE ? await sb_deleteByName(name) : (ls_setDay(ls_getDay().filter(r=>r.name!==name))); }
    };

    // ===================== 画面ロジック =====================
    function applyRole(){
      const badge = $('#roleBadge');
      const scope = $('#scope');
      const roleInfo = $('#roleInfo');
      badge.textContent = state.role;
      roleInfo.textContent = `role: ${state.role}`;
      if(state.role !== 'admin') scope.value = 'mine';
      scope.disabled = (state.role !== 'admin');
    }

    function setProfileUI(){
      const avatar = $('#avatar');
      const welcome = $('#welcome');
      if(state.profile){
        avatar.src = state.profile.pictureUrl || '';
        avatar.style.display = state.profile.pictureUrl ? 'block' : 'none';
        welcome.textContent = `${state.profile.displayName} さん、こんにちは`;
        $('#user').value = state.profile.displayName;
      } else {
        avatar.style.display = 'none';
        welcome.textContent = '未ログイン';
        $('#user').value = '';
      }
    }

    async function ensureLogin(){
      if(!LIFF_ID){ alert('LIFF_ID を設定してください'); return; }
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()) return;
      const profile = await liff.getProfile();
      state.profile = profile;
      state.userName = profile.displayName;
      state.userId = profile.userId;
      state.role = ADMINS.includes(profile.userId) ? 'admin' : 'member';
      $('#btnLogin').style.display = 'none';
      $('#btnLogout').style.display = 'inline-flex';
      setProfileUI();
      applyRole();
      render();
    }

    // ===== 打刻アップサート =====
    async function upsert(action){
      if(!state.profile){ alert('LINEでログインしてください'); return; }
      const name = state.userName;
      const team = $('#team').value.trim();
      const shiftStart = $('#shiftStart').value || '09:00';
      const shiftEnd = $('#shiftEnd').value || '18:00';
      const note = $('#note').value.trim();

      const list = await store.getDay();
      let rec = list.find(r => r.name === name) || { name, team, shiftStart, shiftEnd, note:'', wake:null, depart:null, in:null, out:null };
      rec.team = team; rec.shiftStart = shiftStart; rec.shiftEnd = shiftEnd;
      if(note) rec.note = (rec.note ? rec.note + ' / ' : '') + note;
      const t = nowIso();
      if(action==='wake') rec.wake = rec.wake || t;
      if(action==='depart') rec.depart = rec.depart || t;
      if(action==='clockin') rec.in = rec.in || t;
      if(action==='clockout') rec.out = rec.out || t;

      await store.setOrUpsert(rec);
      $('#note').value = '';
      render();
    }

    async function delRecord(name){
      if(state.role!=='admin' && name!==state.userName){ alert('削除は自分の記録のみ可能です'); return; }
      await store.delByName(name);
      render();
    }

    async function render(){
      const q = $('#search').value.trim().toLowerCase();
      const scope = $('#scope').value; // mine/all
      const list = await store.getDay();
      const tbody = $('#tbody');
      tbody.innerHTML = '';

      const filtered = list.filter(r => {
        const text = JSON.stringify(r).toLowerCase();
        const match = !q || text.includes(q);
        const mine = !state.profile || scope==='all' || r.name===state.userName;
        return match && mine;
      }).sort((a,b)=> (a.team||'').localeCompare(b.team||'') || a.name.localeCompare(b.name));

      let late=0, inOnly=0, count=0;
      const [sh, sm] = ($('#shiftStart').value || '09:00').split(':').map(Number);
      const shiftStartToday = new Date(); shiftStartToday.setHours(sh, sm, 0, 0);

      filtered.forEach(r => {
        count++;
        const tr = document.createElement('tr');
        const isLate = r.in && new Date(r.in) > shiftStartToday;
        const noClockIn = !r.in && (r.wake || r.depart);
        if(isLate) late++;
        if(noClockIn) inOnly++;
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.team||''}</td>
          <td class="mono">${fmtTime(r.wake)}</td>
          <td class="mono">${fmtTime(r.depart)}</td>
          <td class="mono ${isLate?'danger':''}">${fmtTime(r.in)}</td>
          <td class="mono">${fmtTime(r.out)}</td>
          <td>${r.note||''}</td>
          <td><button class="btn-ghost" data-del="${r.name}">🗑️</button></td>`;
        tbody.appendChild(tr);
      });

      $('#kpiPeople').textContent = String(count);
      $('#kpiLate').textContent = String(late);
      $('#kpiNoClockIn').textContent = String(inOnly);

      const alert = [];
      if(late>0) alert.push(`⚠️ 遅刻 ${late} 名`);
      if(inOnly>0) alert.push(`⏳ 未出勤 ${inOnly} 名`);
      $('#alertZone').textContent = alert.join(' / ') || '定時超過の人が出るとここに⚠️を表示します。';

      $('#dataSource').textContent = `Data: ${USE_SUPABASE ? 'Supabase' : 'LocalStorage'}`;
    }

    // ===================== イベント =====================
    document.addEventListener('click', (e)=>{
      if(e.target.matches('[data-action]')) upsert(e.target.getAttribute('data-action'));
      if(e.target.matches('[data-del]')){ const name=e.target.getAttribute('data-del'); if(confirm(`${name} を本日のログから削除しますか？`)) delRecord(name); }
    });
    $('#search').addEventListener('input', render);
    $('#exportCsv').addEventListener('click', async ()=>{
      const list = await store.getDay();
      const headers = ['date','name','team','wake','depart','in','out','shiftStart','shiftEnd','note'];
      const rows = list.map(r => [todayStr(), r.name, r.team||'', r.wake||'', r.depart||'', r.in||'', r.out||'', r.shiftStart||'', r.shiftEnd||'', (r.note||'').replace(/
/g,' ')]);
      const csv = [headers.join(','), ...rows.map(a=>a.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('
');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `attendance_${todayStr()}.csv`; a.click();
    });
    $('#exportJson').addEventListener('click', ()=>{ const data = USE_SUPABASE? { note:'Supabase利用時はDB側が正'}, ls_getAll(); });
    $('#importFile').addEventListener('change', (e)=> e.target.files[0] && (function(file){ const reader=new FileReader(); reader.onload=()=>{ try{ const obj=JSON.parse(reader.result); if(typeof obj!== 'object') throw new Error('形式不正'); localStorage.setItem(LS_KEY, JSON.stringify(obj)); render(); alert('読み込みました'); }catch{ alert('JSONの形式が不正です'); } }; reader.readAsText(file); })(e.target.files[0]));
    $('#clearToday').addEventListener('click', async ()=>{ if(confirm('本日のレコードを全て削除します。よろしいですか？')){ if(USE_SUPABASE){ const list=await store.getDay(); for(const r of list){ await store.delByName(r.name); } } else { ls_setDay([]); } render(); }});

    $('#quickLate').addEventListener('click', ()=> $('#note').value = ($('#note').value? $('#note').value+' / ' : '') + '5分遅れ');
    $('#quickWorkFromHome').addEventListener('click', ()=> $('#note').value = ($('#note').value? $('#note').value+' / ' : '') + '在宅');

    $('#scope').addEventListener('change', render);

    // ===================== 起動時処理 =====================
    (async function init(){
      if(USE_SUPABASE) await sb_init();
      applyRole(); setProfileUI(); render();
      try{ await ensureLogin(); }catch(e){ console.warn('LIFF初期化未設定 or 非対応環境', e); }

      // ログイン/アウト
      $('#btnLogin').onclick = ()=> liff.login();
      $('#btnLogout').onclick = ()=> { liff.logout(); location.reload(); };
    })();
  </script>
</body>
</html>

</html>

